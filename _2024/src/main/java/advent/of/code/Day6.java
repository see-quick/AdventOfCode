package advent.of.code;

import java.util.HashSet;
import java.util.Set;

public class Day6 {

    static class Game {

        private final char[][] board;
        private final Player player;

        public Game(char[][] board) {
            this.board = board;
            this.player = new Player(Metadata.findPlayerWithDirection(this.board));
            postProcessBoard();
        }

        private static char turnRight(char d) {
            return switch (d) {
                case '^' -> '>';
                case '>' -> 'v';
                case 'v' -> '<';
                case '<' -> '^';
                default -> d;
            };
        }

        public void postProcessBoard() {
            for (int i = 0; i < board.length; i++) {
                for (int j = 0; j < board[i].length; j++) {
                    char c = board[i][j];
                    if (c == '<' || c == '>' || c == '^' || c == 'v') {
                        board[i][j] = '.';
                    }
                }
            }
        }

        public void start() {
            Set<String> seenStates = new HashSet<>();
            // Directions: ^ means (y-1), > means (x+1), v means (y+1), < means (x-1)
            // Keep rotating right if blocked by '#' or 'O', move if '.' or 'x', stop if out-of-board.

            while (true) {
                if (withinBoard(player.metadata.x, player.metadata.y)) {
                    board[player.metadata.y][player.metadata.x] = 'x';
                }

                String state = player.metadata.x + "," + player.metadata.y + "," + player.metadata.direction;
                if (!seenStates.add(state)) {
                    System.out.println("Cycle detected, stopping the game.");
                    break;
                }

                // Compute next step
                int nextX = player.metadata.x;
                int nextY = player.metadata.y;
                if (player.metadata.direction == '^') nextY--;
                else if (player.metadata.direction == '>') nextX++;
                else if (player.metadata.direction == 'v') nextY++;
                else if (player.metadata.direction == '<') nextX--;

                // Check out-of-bounds
                if (!withinBoard(nextX, nextY)) {
                    // Out of board => stop
                    break;
                }

                char nextCell = board[nextY][nextX];
                if (nextCell == '#' || nextCell == 'O') {
                    // Turn right, do not move
                    player.metadata.direction = turnRight(player.metadata.direction);
                } else {
                    // Move forward
                    player.moveForward();
                }
            }

            System.out.println("Game stopped");

            System.out.println("Guard visit: " + this.player.steps + " steps on board/map");
            System.out.println("Guard visit: " + this.player.visitedPositions.size() + " distinct steps on board/map");
        }

        private boolean withinBoard(int x, int y) {
            return y >= 0 && y < board.length && x >= 0 && x < board[y].length;
        }
    }

    static class Player {

        private int steps;
        private Metadata metadata;
        private Set<String> visitedPositions;

        public Player(Metadata metadata) {
            this.metadata = metadata;
            this.steps = 0;
            this.visitedPositions = new HashSet<>();
            // Add the initial position to visitedPositions
            this.visitedPositions.add(metadata.x + "," + metadata.y);
        }

        public void moveForward() {
            if (this.metadata.direction == '^') {
                this.metadata.y--;
            } else if (this.metadata.direction == '>') {
                this.metadata.x++;
            } else if (this.metadata.direction == 'v') {
                this.metadata.y++;
            } else if (this.metadata.direction == '<') {
                this.metadata.x--;
            }
            this.steps++;
            this.visitedPositions.add(this.metadata.x + "," + this.metadata.y);
        }
    }

    static class Metadata {

        private int x;
        private int y;
        private char direction;

        private Metadata(int x, int y, char direction) {
            this.x = x;
            this.y = y;
            this.direction = direction;
        }

        public static Metadata findPlayerWithDirection(char[][] board) {
            for (int i = 0; i < board.length; i++) {
                for (int j = 0; j < board[i].length; j++) {
                    char cell = board[i][j];
                    if (cell == '<' || cell == '>' || cell == '^' || cell == 'v') {
                        // (j = x, i = y)
                        return new Metadata(j, i, cell);
                    }
                }
            }
            return null;
        }
    }

    // If there is something directly in front of you, turn right 90 degrees.
    public static void main(String[] args) {

        char[][] miniBoard = {
            {'.', '.', '.', '.', '#', '.', '.', '.', '.', '.'},
            {'.', '.', '.', '.', '.', '.', '.', '.', '.', '#'},
            {'.', '.', '.', '.', '.', '.', '.', '.', '.', '.'},
            {'.', '.', '#', '.', '.', '.', '.', '.', '.', '.'},
            {'.', '.', '.', '.', '.', '.', '.', '#', '.', '.'},
            {'.', '.', '.', '.', '.', '.', '.', '.', '.', '.'},
            {'.', '#', '.', '.', '^', '.', '.', '.', '.', '.'},
            {'.', '.', '.', '.', '.', '.', '.', '.', '#', '.'},
            {'#', '.', '.', '.', '.', '.', '.', '.', '.', '.'},
            {'.', '.', '.', '.', '.', '.', '#', '.', '.', '.'}
        };

        char[][] board = {
            "......##...#...#....#.......#....................##............#.#..#.......#.........................................#...........".toCharArray(),
            "..................................#.............#................................#..........##..................#.................".toCharArray(),
            "....#......................#................#...........................................#....................................#....".toCharArray(),
            "............#..............#...#...#...............#..........#.#....#..........................#....##...........................".toCharArray(),
            "....#.............#.....#.....................................................................#...#..........................#....".toCharArray(),
            ".................#............#......................#.................#.............#..................#.........................".toCharArray(),
            "................#...............#....................#...#..#...#.#.....................................................#.........".toCharArray(),
            "..............#.#...............................................................#....................#.......#....................".toCharArray(),
            ".............#...#..#............................#..............#..#.........................................#....................".toCharArray(),
            ".........................#.........#..#.......#...#..............#..#..............................#.........#............#.......".toCharArray(),
            "#...............................................................................................................#.................".toCharArray(),
            "..........................#.....#.........................#...................#.......#.........................#.................".toCharArray(),
            "...........#...........#........#........................#..........#.#.................#........#............#...............#...".toCharArray(),
            "..#..#................#...................................................#..................................................#....".toCharArray(),
            ".....#............................#..........................................................................#....................".toCharArray(),
            "................#.....#...........................#..........................................#.........#........................#.".toCharArray(),
            "..#...........................................##............#.........#..........................#.......................#.....#..".toCharArray(),
            ".....................#.............#.....#.......#.##.....#......................................#.#..#.#.........................".toCharArray(),
            ".......#...##.....#..........#...............#....#..........................#..............................................##....".toCharArray(),
            "..#.......#..................##..............#..........................#.#....#....#....................#.#.#...............#....".toCharArray(),
            "....................#.......#.......#............#..............#.......#.........#...#.....#........#.#..........................".toCharArray(),
            "...............................................#.....#........................................#..#.........#..........#...........".toCharArray(),
            "............#...#.............................................................................#.......##..........................".toCharArray(),
            "##..........................#...........................#..............................#..........................................".toCharArray(),
            "..............................................#.............................................#.................................#...".toCharArray(),
            ".............#..............#................##...........#...............#.......................................................".toCharArray(),
            "......#............#.......#..#....#.............................................................................#.#..............".toCharArray(),
            "..#..##..#..................#...............................................##......#........................................#....".toCharArray(),
            "..#...............................#.#........#................................................#.....#........#.#..................".toCharArray(),
            ".........#.......#.....................................#............................#..............................#..............".toCharArray(),
            "..........................................................................................................#.....................#.".toCharArray(),
            "....................#......................................#..........................#.........................##................".toCharArray(),
            "........#..............................................................................#.#..................#..................#..".toCharArray(),
            "........................................................^..#...................#....#..............##.............................".toCharArray(),
            "..#.#........................................................#..#..................#.....................................#....#...".toCharArray(),
            ".........................#....#............................#......................................................................".toCharArray(),
            ".#......#.............................................................................................#....................###....".toCharArray(),
            "...........#...#.#............#........................................................................#..........................".toCharArray(),
            "......#..........#.............................#.#.................................#...#.............#.#........................#.".toCharArray(),
            "...............................................#..........#.......#.........#........................................#.#..........".toCharArray(),
            ".................#.....................#.......#..................................................................................".toCharArray(),
            ".#...............#.........#...................#..............#........................#.....#....................................".toCharArray(),
            "...........#..............#..................................................................#...................................#".toCharArray(),
            ".................#.............#...........#.......................................#......................#......#..........#.....".toCharArray(),
            "........#..#.................#..........#....................................................#.....#...........#.................#".toCharArray(),
            ".....................#..#.................#......#......#..#..#..........#........................#...........................##..".toCharArray(),
            ".................#........#....#.................................................#.#.........................#............#..#....".toCharArray(),
            ".....................#...............##...................#.....#..#............................#.#.............#.................".toCharArray(),
            ".#..#......##...............#.......#..........................................................................#......#...........".toCharArray(),
            "#..#...................................#.#................#.....#.................................#...........................#...".toCharArray(),
            "..............#............................#............#...#...#.............#..........#............#...#............#..........".toCharArray(),
            "..........##.................#................................#...........#.#....#...............................................#".toCharArray(),
            "......#...........#.............#..........#.............#............#...................#.......................#...............".toCharArray(),
            "..............#.......#...........................................................................................................".toCharArray(),
            "...#................................................................#...............................#....#...............#........".toCharArray(),
            "...#..##................#..............................................................................#..........##.#............".toCharArray(),
            ".#........#..........#..................#......................#...........#......................................................".toCharArray(),
            "....#.......................#...#...........................................#..................#...............................#..".toCharArray(),
            ".............................#...........#..........#.................#.....................................................#.....".toCharArray(),
            "...........#.........#............#...............................#................#..............#.........................#.....".toCharArray(),
            "..........#........#.....#.....................................#.................#.....................................#..#.......".toCharArray(),
            "...#.......#...................................................................#.................#...............................".toCharArray(),
            ".#....#........#..............................#........#.....#........#..#...#.#......................#..........................#".toCharArray(),
            ".....................................................................#....................#.......................................".toCharArray(),
            ".............................#..............................#.#....................................................#............#.".toCharArray(),
            "..#.....#.......#.......#......................#.#.#.........................................................#.....#........#.....".toCharArray(),
            "...............#..........#..#....#..................#..........................................#.................................".toCharArray(),
            "............#...................#................#.............................................................................#..".toCharArray(),
            "........#...#......................................##....................#..................#..........##............#...#........".toCharArray(),
            "......................#......#......#.#.........................................................................#.............#...".toCharArray(),
            "........#......................................................................................#.................#................".toCharArray(),
            ".................................................#....................#..............##.......................................#..#".toCharArray(),
            ".............#..........................................................#.................#..........................#....#......#".toCharArray(),
            "......................#.....................#............................#..................#...........#.........................".toCharArray(),
            "#..............#...........................#...#.#................................................................................".toCharArray(),
            ".......#............................#...........................................................#...............#.................".toCharArray(),
            "........................#..................................................................................#......................".toCharArray(),
            "...................#..........................#.........#........#...........................#....................................".toCharArray(),
            ".............#............#.......................................................................................##....#.........".toCharArray(),
            "................#.........#.....................................................................................................#.".toCharArray(),
            "........#.............................#.................................#.......##..............#............................#....".toCharArray(),
            "#........#.....#.....#.......#...............................#....................................................#..............#".toCharArray(),
            "........................#.............................#.....#...........#........#............#...................................".toCharArray(),
            "..................#...........#...#.............................................................................#...............#.".toCharArray(),
            "...................#..................#...................#..............................#....#...........#..............#........".toCharArray(),
            "...............#................#.#....................#.........#.........#.............#.........#......#..................#....".toCharArray(),
            "..................#.............................#...........................#....#....#......#..#.#....................#..........".toCharArray(),
            "...#.......................................#...............................................................#................#.....".toCharArray(),
            "...................#.........................................................#....................................................".toCharArray(),
            ".................#..............................#.................................................................................".toCharArray(),
            ".............#.......#...#....................................................#........#....................................#...#.".toCharArray(),
            "..............#...................#.#..........#....................................................#....#...#.##....#............".toCharArray(),
            "........#..#...........................................#.........#...#...............#.........................#..................".toCharArray(),
            "#.....#...........................................#.................................................#.............................".toCharArray(),
            "#...........................................#..........#..........................................#...............#...............".toCharArray(),
            "............................#.................................................#...#...............................................".toCharArray(),
            ".#...................#.......................................................................................#......#...##..#.....".toCharArray(),
            ".....#..#...............#........#....#.........#........................#.............#..........................................".toCharArray(),
            "...................#................#........................................#.#..................................................".toCharArray(),
            "......#.#...........................#...................#..........#..........#......#............................................".toCharArray(),
            "..........................#.#..............#............#.#.......................................................................".toCharArray(),
            "...#..#........................#..............................................#..#...#.....#........#.............................".toCharArray(),
            "..........................#.....................#.........................................................#............#.#........".toCharArray(),
            "............................#.....................#.............#.................................................................".toCharArray(),
            "..........................................#..#.................................................................#......#.#.#.......".toCharArray(),
            "..........##......................................#................................##....................#..#.....................".toCharArray(),
            "..............#.......................................................#...........................................................".toCharArray(),
            "..........#........#........................................................................................#........#...#........".toCharArray(),
            "......................#.#...................#...............#.....#......................#.....#.......#.......#..........#.......".toCharArray(),
            "......#..#....#..................#.........................................#......................................................".toCharArray(),
            "...............#.....#..#..........................................##.........................................##.............#....".toCharArray(),
            ".....................#..................#..................................#...................#............................#.#...".toCharArray(),
            "..#................#..#................................................#...........#..........#.............#...................#.".toCharArray(),
            ".......#.............#.......................................................................#...#.........................##..#..".toCharArray(),
            "...#...................#..................#.............#..#.........................................#........##..................".toCharArray(),
            ".................................#...........#........#.....................#.........................#..#........................".toCharArray(),
            ".......#..................#..................................#......................................#.#....................#......".toCharArray(),
            "..................................................................................#...........#....#.......#......#..........#....".toCharArray(),
            "........##.........................................................#.......................#........#............#................".toCharArray(),
            "...#...............##.#..................#....................................#.............#.................#...................".toCharArray(),
            "..................##.........#...................#......#................#......................................................#.".toCharArray(),
            ".#....................#............#..............#.............#.........#........................................#......#..#....".toCharArray(),
            "...............#...........................................................#........................#.............#...............".toCharArray(),
            "#............................#...................#...............................##..#...............#..........................#.".toCharArray(),
            "................#.............#..........#.........#..........................#....#..............................#..............#".toCharArray(),
            "...................................#.........................................#....................................................".toCharArray(),
            "....#................................................................#.#..#..........#....#.............................#.........".toCharArray(),
            "...........#.............#..........#........#...#...#........#.............#.......................................##............".toCharArray(),
            ".........#.......................#..........#....#.......................................#.....#...#.#..........#.................".toCharArray(),
            ".......................#...........#.......#......#.#...............................................#.................#.#.........".toCharArray(),
        };

        Game game = new Game(board);

        game.start();
    }
}
